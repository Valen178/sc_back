=== GUÍA DE CONFIGURACIÓN Y TESTING DEL PROYECTO ===
Versión: 1.0.0
Última actualización: 09/09/2025

=== REQUISITOS PREVIOS ===

1. Node.js ≥ 14.0.0
2. npm ≥ 6.0.0
3. Cuenta en Supabase
4. (Opcional) Cuenta en Google Cloud para OAuth

=== CONFIGURACIÓN INICIAL (Después de clonar) ===

1. Instalar Dependencias:
   ```bash
   npm install
   ```

2. Configurar Variables de Entorno:
   - Crear archivo `.env` en la raíz del proyecto
   - Copiar el contenido de `.env.example` (si existe) o usar esta estructura:
   ```
   # Supabase configuration
   SUPABASE_URL=tu_url_de_supabase
   SUPABASE_ANON_KEY=tu_anon_key_de_supabase

   # Server configuration
   PORT=3000

   # JWT configuration
   JWT_SECRET=genera_una_clave_secreta
   JWT_EXPIRES_IN=24h

   # Google OAuth (opcional si no usarás login con Google)
   GOOGLE_CLIENT_ID=tu_google_client_id
   GOOGLE_CLIENT_SECRET=tu_google_client_secret
   GOOGLE_CALLBACK_URL=http://localhost:3000/auth/google/callback
   ```

3. Generar JWT_SECRET:
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```
   - Copiar el resultado en la variable JWT_SECRET del archivo .env

4. Configurar Base de Datos y Storage:
   a) Crear proyecto en Supabase (https://supabase.com)
   b) Configurar Storage:
      - Ir a Storage en el dashboard de Supabase
      - Crear un nuevo bucket llamado 'profile_photos'
      - Ejemplo SQL:
      ```sql
      CREATE BUCKET IF NOT EXISTS profile_photos;
      ```
   c) Configurar tablas:
      - Agregar columna photo_url a las tablas de perfiles:
      ```sql
      ALTER TABLE athlete ADD COLUMN IF NOT EXISTS photo_url VARCHAR;
      ALTER TABLE agent ADD COLUMN IF NOT EXISTS photo_url VARCHAR;
      ALTER TABLE team ADD COLUMN IF NOT EXISTS photo_url VARCHAR;
      ```

5. Configurar Google OAuth (opcional):
   - Ir a Google Cloud Console (https://console.cloud.google.com)
   - Crear un nuevo proyecto
   - Habilitar Google OAuth API
   - Crear credenciales OAuth 2.0
   - Configurar pantalla de consentimiento
   - Agregar las URLs de redirección
   - Copiar Client ID y Client Secret al .env

=== TESTING DEL PROYECTO ===

1. Herramientas Recomendadas:
   - Postman (https://www.postman.com/downloads/)
   - Thunder Client (extensión de VS Code)
   - Insomnia (https://insomnia.rest/download)

2. Configuración en Postman/Thunder Client:
   a) Crear una nueva colección "Backend API"
   b) Configurar variables de entorno:
      - BASE_URL: http://localhost:3000
      - TOKEN: (se llenará después del login)

3. Flujo de Testing:

   A. Pruebas de Autenticación:

   1. Registro de Usuario:
   ```
   POST {{BASE_URL}}/auth/signup
   Body:
   {
     "email": "test@example.com",
     "password": "password123"
   }
   ```

   2. Login Normal:
   ```
   POST {{BASE_URL}}/auth/login
   Body:
   {
     "email": "test@example.com",
     "password": "password123"
   }
   ```
   - Guardar el token recibido en la variable de entorno TOKEN

   3. Login con Google:
   ```
   POST {{BASE_URL}}/auth/google
   Body:
   {
     "token": "google-oauth-token"
   }
   ```

   4. Completar Perfil:
   
   a) Perfil de Atleta:
   ```
   POST {{BASE_URL}}/auth/complete-profile
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "profileType": "athlete",
     "name": "John",
     "last_name": "Doe",
     "birthdate": "2000-01-01",
     "height": 180,
     "weight": 75,
     "location_id": 1,
     "sport_id": 1,
     "phone_number": 1234567890,
     "ig_user": "john_doe",      // opcional
     "x_user": "johndoe",         // opcional
     "description": "Athlete from XYZ"     // opcional
   }
   ```

   b) Perfil de Agente:
   ```
   POST {{BASE_URL}}/auth/complete-profile
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "profileType": "agent",
     "name": "Jane",
     "last_name": "Smith",
     "description": "Experienced sports agent",
     "location_id": 1,
     "sport_id": 1,
     "phone_number": 9876543210,
     "ig_user": "jane_smith",      // opcional
     "x_user": "janesmith",         // opcional
     "agency": "Sports Agency"     // opcional
   }
   ```

   c) Perfil de Equipo:
   ```
   POST {{BASE_URL}}/auth/complete-profile
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "profileType": "team",
     "name": "City Football Club",
     "job": "Head Scout",
     "description": "Premier league team",
     "sport_id": 1,
     "location_id": 1,
     "phone_number": 5551234567,
     "ig_user": "city_fc",      // opcional
     "x_user": "cityfootballclub"         // opcional
   }
   ```

   B. Pruebas de Perfil:

   1. Obtener Perfil:
   ```
   GET {{BASE_URL}}/profile/me
   Headers:
   Authorization: Bearer {{TOKEN}}
   ```

   2. Actualizar Perfil:
   ```
   PUT {{BASE_URL}}/profile/me
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "userUpdates": {
       "email": "updated@example.com"
     },
     "profileUpdates": {
       // Campos según tipo de perfil
     }
   }
   ```

   3. Eliminar Perfil:
   ```
   DELETE {{BASE_URL}}/profile/me
   Headers:
   Authorization: Bearer {{TOKEN}}
   ```

   4. Gestión de Fotos de Perfil:

   a) Subir Foto de Perfil:
   ```
   POST {{BASE_URL}}/api/profile-photo/upload
   Headers:
   Authorization: Bearer {{TOKEN}}
   Content-Type: multipart/form-data
   Body (form-data):
   - photo: [archivo de imagen]
   - profileType: "athlete" // o "agent" o "team"
   ```
   Notas:
   - Tamaño máximo: 5MB
   - Formatos permitidos: imágenes (jpg, png, etc.)
   - La foto anterior se reemplazará automáticamente

   b) Eliminar Foto de Perfil:
   ```
   DELETE {{BASE_URL}}/profile-photo/delete
   Headers:
   Authorization: Bearer {{TOKEN}}
   Content-Type: application/json
   Body:
   {
     "profileType": "athlete" // o "agent" o "team"
   }
   ```
   Notas:
   - La foto se eliminará del storage
   - El campo photo_url se establecerá en null

5. Testing de Funcionalidades de Swipe y Matches:

   A. Dar Like/Dislike a Usuario:
   ```
   POST {{BASE_URL}}/swipe
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "swiped_user_id": 123,
     "action": "like" // o "dislike"
   }
   ```
   Notas:
   - Solo se puede interactuar con usuarios del mismo deporte
   - No se puede dar like/dislike a uno mismo
   - Si ambos usuarios se dan like, se crea un match automáticamente

   B. Obtener Usuarios para Descubrir:
   ```
   GET {{BASE_URL}}/swipe/discover?profile_type_filter=team&limit=10
   Headers:
   Authorization: Bearer {{TOKEN}}
   ```
   Query Parameters:
   - profile_type_filter: "team" | "agent" | "both" (opcional)
   - limit: número máximo de usuarios (default: 10)
   
   Notas:
   - Los atletas pueden ver equipos y agentes
   - Los equipos y agentes pueden ver atletas
   - Solo muestra usuarios del mismo deporte
   - Excluye usuarios ya vistos

   C. Obtener Matches del Usuario:
   ```
   GET {{BASE_URL}}/swipe/matches
   Headers:
   Authorization: Bearer {{TOKEN}}
   ```
   Response incluye:
   - Lista de matches activos
   - Información del otro usuario en cada match
   - Tipo de perfil del otro usuario

   D. Obtener Estadísticas de Swipes:
   ```
   GET {{BASE_URL}}/swipe/stats
   Headers:
   Authorization: Bearer {{TOKEN}}
   ```
   Response incluye:
   - Swipes enviados (total, likes, dislikes)
   - Swipes recibidos (total, likes, dislikes)
   - Número total de matches

6. Testing de Panel Admin:

   A. Preparación:
      a) Crear admin:
         - Ir a Supabase Table Editor
         - Encontrar el usuario en la tabla 'users'
         - Cambiar su role a 'admin'
         - Hacer login nuevamente para obtener token con rol admin
   
   B. Gestión de Usuarios:
      1. Listar Usuarios:
      ```
      GET {{BASE_URL}}/admin/users
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      2. Obtener Usuario:
      ```
      GET {{BASE_URL}}/admin/users/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      3. Actualizar Usuario:
      ```
      PUT {{BASE_URL}}/admin/users/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "email": "updated@example.com"
      }
      ```

      4. Cambiar Rol:
      ```
      PATCH {{BASE_URL}}/admin/users/:id/role
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "role": "admin" // o "user"
      }
      ```

      5. Eliminar Usuario:
      ```
      DELETE {{BASE_URL}}/admin/users/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

   C. Gestión de Deportes:
      1. Listar Deportes:
      ```
      GET {{BASE_URL}}/admin/sports
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      2. Crear Deporte:
      ```
      POST {{BASE_URL}}/admin/sports
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "name": "Football",
      }
      ```

      3. Actualizar Deporte:
      ```
      PUT {{BASE_URL}}/admin/sports/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "name": "Soccer",
      }
      ```

      4. Eliminar Deporte:
      ```
      DELETE {{BASE_URL}}/admin/sports/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

   D. Gestión de Ubicaciones:
      1. Listar Ubicaciones:
      ```
      GET {{BASE_URL}}/admin/locations
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      2. Crear Ubicación:
      ```
      POST {{BASE_URL}}/admin/locations
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "country": "Spain",
        "province": "Madrid",
        "city": "Madrid"
      }
      ```

      3. Actualizar Ubicación:
      ```
      PUT {{BASE_URL}}/admin/locations/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "country": "Spain",
        "province": "Barcelona",
        "city": "Barcelona"
      }
      ```

      4. Eliminar Ubicación:
      ```
      DELETE {{BASE_URL}}/admin/locations/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

   E. Gestión de Planes:
      1. Listar Planes:
      ```
      GET {{BASE_URL}}/admin/plans
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      2. Crear Plan:
      ```
      POST {{BASE_URL}}/admin/plans
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "name": "Plan Premium",
        "price": 2999
      }
      ```

      3. Eliminar Plan:
      ```
      DELETE {{BASE_URL}}/admin/plans/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

   F. Gestión de Suscripciones:
      1. Listar Suscripciones:
      ```
      GET {{BASE_URL}}/admin/subscriptions
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      2. Obtener Suscripción:
      ```
      GET {{BASE_URL}}/admin/subscriptions/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      3. Actualizar Suscripción:
      ```
      PUT {{BASE_URL}}/admin/subscriptions/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      Body:
      {
        "end_date": "2024-12-31"
      }
      ```

      4. Eliminar Suscripción:
      ```
      DELETE {{BASE_URL}}/admin/subscriptions/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

   G. Gestión de Posts:
      1. Listar Posts:
      ```
      GET {{BASE_URL}}/admin/posts
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      2. Obtener Post:
      ```
      GET {{BASE_URL}}/admin/posts/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

      3. Eliminar Post:
      ```
      DELETE {{BASE_URL}}/admin/posts/:id
      Headers:
      Authorization: Bearer {{TOKEN}}
      ```

7. Testing de Consultas Públicas:
   
   A. Deportes:
   ```
   GET {{BASE_URL}}/lookup/sports
   ```

   B. Ubicaciones:
   ```
   GET {{BASE_URL}}/lookup/locations
   GET {{BASE_URL}}/lookup/locations/country/:country
   ```

8. Pruebas de Validación:

   A. Campos Requeridos:
   ```
   POST {{BASE_URL}}/auth/complete-profile
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "profileType": "athlete"
     // Omitir campos requeridos para probar validación
   }
   ```

   B. Referencias Inválidas:
   ```
   POST {{BASE_URL}}/auth/complete-profile
   Headers:
   Authorization: Bearer {{TOKEN}}
   Body:
   {
     "profileType": "athlete",
     "name": "John",
     "last_name": "Doe",
     "location_id": 999999, // ID inexistente
     "sport_id": 999999    // ID inexistente
   }
   ```

   C. Permisos:
   ```
   GET {{BASE_URL}}/admin/users
   Headers:
   Authorization: Bearer {{TOKEN-NO-ADMIN}}
   ```

9. Verificación de Respuestas:
   
   A. Códigos de Estado:
   - 200: Éxito en operación GET/PUT
   - 201: Éxito en operación POST (creación)
   - 400: Error de validación
   - 401: No autenticado
   - 403: No autorizado
   - 404: Recurso no encontrado
   - 500: Error del servidor

   B. Formato de Respuesta:
   ```json
   // Éxito
   {
     "message": "Mensaje descriptivo",
     "data": {
       // Datos solicitados
     }
   }

   // Error
   {
     "message": "Descripción del error",
     "errors": [
       // Detalles específicos
     ]
   }
   ```

10. Ejecutar el Proyecto:
   
   A. Desarrollo (con hot reload):
   ```bash
   npm run dev
   ```

   B. Producción:
   ```bash
   npm start
   ```

=== SOLUCIÓN DE PROBLEMAS COMUNES ===

1. Problemas de Servidor:
   
   A. Puerto en uso:
   ```bash
   npx kill-port 3000
   ```

   B. Error de conexión a Supabase:
   - Verificar credenciales en .env
   - Verificar estado del proyecto en Supabase
   - Comprobar conexión a internet
   - Verificar políticas de seguridad en Supabase

2. Problemas de Autenticación:

   A. Token inválido:
   - Verificar formato: "Bearer <token>"
   - Comprobar expiración del token
   - Verificar JWT_SECRET en .env

   B. Login fallido:
   - Verificar credenciales
   - Comprobar estado del usuario
   - Verificar conexión con Supabase

3. Problemas de CORS:
   - Verificar origenes permitidos en index.js
   - Comprobar headers en peticiones
   - Verificar métodos HTTP permitidos

4. Problemas de Validación:
   - Verificar campos requeridos
   - Comprobar formatos de datos
   - Validar referencias existentes

5. Problemas con Fotos de Perfil:
   
   A. Error al subir foto:
   - Verificar tamaño del archivo (máx. 5MB)
   - Comprobar formato de imagen válido
   - Verificar conexión con Supabase Storage
   - Revisar permisos del bucket

   B. Error al acceder a foto:
   - Verificar que la URL es pública
   - Comprobar que el archivo existe
   - Verificar permisos del bucket
   - Revisar el formato de la URL

   C. Error al eliminar foto:
   - Verificar que el archivo existe
   - Comprobar permisos del bucket
   - Verificar que la URL es válida

6. Problemas con Funcionalidades de Swipe:

   A. Error al dar like/dislike:
   - Verificar que ambos usuarios tienen perfil completo
   - Comprobar que pertenecen al mismo deporte
   - Verificar que no se está dando like a uno mismo
   - Comprobar que no se ha interactuado previamente

   B. No aparecen usuarios en discover:
   - Verificar que el usuario tiene perfil completo
   - Comprobar que hay otros usuarios del mismo deporte
   - Verificar que no se han visto todos los usuarios disponibles
   - Comprobar filtros de tipo de perfil

   C. Error en matches:
   - Verificar que ambos usuarios se dieron like mutuamente
   - Comprobar estado de match en la base de datos
   - Verificar que el match_state es 'active'
   - Revisar integridad de datos en tablas match y swipes

=== RECOMENDACIONES DE TESTING ===

1. Automatización:
   - Mantener colección de Postman/Thunder Client
   - Crear scripts de prueba
   - Automatizar casos comunes

2. Cobertura:
   - Probar todos los endpoints
   - Incluir casos de error
   - Verificar validaciones
   - Probar permisos
   - Probar funcionalidades de swipe y matches
   - Verificar gestión de fotos de perfil
   - Probar funcionalidades de admin (planes, suscripciones)

3. Mantenimiento:
   - Actualizar pruebas con cambios
   - Documentar nuevos casos
   - Revisar periódicamente
   - Hacer backup de datos de prueba

4. Seguridad:
   - Probar inyección SQL
   - Verificar autenticación
   - Comprobar autorización
   - Validar entrada de datos
   - Probar acceso a recursos de otros usuarios
   - Verificar permisos de admin
   - Comprobar validación de archivos subidos

=== NOTAS DE SEGURIDAD ===

1. Configuración:
   - No compartir .env
   - Cambiar JWT_SECRET en producción
   - Usar HTTPS en producción
   - Mantener dependencias actualizadas

2. Datos Sensibles:
   - No exponer información privada
   - Encriptar datos sensibles
   - Usar variables de entorno
   - Hacer backup seguro

3. Monitoreo:
   - Registrar intentos de acceso
   - Monitorear errores
   - Revisar logs regularmente
   - Actualizar políticas de seguridad

4. Mejores Prácticas:
   - Validar todas las entradas
   - Sanitizar datos
   - Limitar intentos de login
   - Implementar rate limiting
   - Validar tipos de archivo en uploads
   - Implementar límites de tamaño de archivo
   - Usar HTTPS en producción
   - Configurar políticas de CORS apropiadas
